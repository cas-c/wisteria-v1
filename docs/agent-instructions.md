# Agent Instructions — Wisteria

Read this before making any changes. For phase-specific implementation
details and pitfalls, see [`phase-playbook.md`](phase-playbook.md).

---

## Project Context

Wisteria is a Japanese figurine e-commerce store. The owner (Cassie) is a
strong TypeScript/Next.js developer learning Python/FastAPI.

**Always explain Python/FastAPI idioms and patterns when using them.**
Especially: SQLAlchemy patterns, FastAPI dependency injection, Pydantic
schemas, Python async, Alembic migrations. TypeScript patterns don't need
explanation unless unusual.

---

## Architecture Rules

### Backend (Python / FastAPI)

- **Async everywhere.** All routes `async def`, all DB queries use `await`.
- **Service layer pattern.** Routes handle HTTP concerns; business logic
  lives in `app/services/`. Routes call services, services call the DB.
- **Pydantic schemas for all request/response bodies.** Never return raw
  SQLAlchemy models from routes.
- **Dependency injection.** DB sessions via `Depends(get_db)`, auth via
  `Depends(get_current_admin)`.
- **Money is always integer cents.** `price_cents: int`. Never `float`.
- **UUIDs for all primary keys.**
- **Slugs for public lookups** (`/products/{slug}`), UUIDs for admin routes
  (`/admin/products/{id}`).

### Frontend (TypeScript / Next.js)

- **Server Components by default.** Only `"use client"` when needed.
- **API calls via `src/lib/api.ts`.** Never raw `fetch()` in components.
- **Types in `src/types/index.ts`.** Must mirror backend Pydantic schemas.

### Database

- **Alembic for all schema changes.** Change model → autogenerate → review → upgrade.
- **Always review autogenerated migrations** before running.

---

## File Organization

```
backend/app/
  config.py, database.py, main.py, dependencies.py
  models/    — SQLAlchemy models (one per table)
  schemas/   — Pydantic request/response schemas
  routers/   — Route handlers (thin — delegate to services)
  services/  — Business logic (one per domain)
  utils/     — Helpers (JWT, hashing, email)

frontend/src/
  app/         — Next.js App Router pages
  components/  — ui/, layout/, product/, cart/, order/
  lib/         — API client, utils, constants
  hooks/       — Custom React hooks
  stores/      — Zustand stores
  types/       — TypeScript interfaces
```

---

## Python Coding Standards

- Ruff for formatting/linting (replaces Black + isort + flake8)
- mypy strict mode
- `collections.abc` imports (not `typing`) for `AsyncGenerator`, `Sequence`, etc.
- Google-style docstrings for public functions

TypeScript and general coding standards are in the workspace `CLAUDE.md`.

---

## How to Run

```bash
docker compose -f docker/docker-compose.yml up                              # Full stack
docker compose -f docker/docker-compose.yml exec backend pytest tests/ -v   # Backend tests
cd frontend && npm run test:e2e                                             # Playwright E2E
```

Migrations: `cd backend && alembic revision --autogenerate -m "desc" && alembic upgrade head`

---

## Testing Strategy

- Tests run against `wisteria_test` DB, never dev `wisteria`. See ADR 010.
- `conftest.py` auto-creates test DB. TRUNCATE between tests for isolation.
- **TDD (Phase 3+):** schemas → failing service tests → implement → failing
  route tests → implement → refactor. See ADR 011.
- Test behavior, not implementation. Real DB calls, not mocks.

---

## Documentation Maintenance

After completing a phase, update:

- `docs/todo.md` — check off items
- `docs/phase-N-takeaways.md` — create for completed phase
- `docs/decisions/` — add ADR if significant decision made
- This file — if architecture or file org changed
