# Phase 5A Takeaways — Order Models, Migration, and Schemas

**Completed:** 2026-02-18

---

## What We Built

- `Order` and `OrderItem` SQLAlchemy models with `OrderStatus` enum
- Pydantic schemas for checkout requests and order responses
- Alembic migration creating `orders` and `order_items` tables

---

## Key Decisions

### Snapshot Fields on OrderItem

`OrderItem` stores `product_name` and `price_cents` directly, duplicating
data from `Product`. This is intentional — order history must survive product
deletion or price changes. The `product_id` FK uses `SET NULL` on delete, so
the link breaks cleanly but the snapshot fields preserve the record.

**Pattern:** This is standard for e-commerce. Never rely on a live product
record for historical order data.

### JSONB for Shipping Address

`shipping_address_json` uses Postgres JSONB instead of separate columns.
Address formats vary by country (US has states, UK has counties, Japan has
prefectures + postal codes in different format). JSONB handles this without
schema changes.

**SQLAlchemy syntax:**
```python
from sqlalchemy.dialects.postgresql import JSONB
shipping_address_json: Mapped[dict] = mapped_column(JSONB, default=dict)
```

`default=dict` is a Python-side default — SQLAlchemy calls `dict()` for each
new row. Don't use `default={}` (mutable default argument gotcha).

### Index on order_items.order_id (Manual Addition)

Alembic autogenerate created the FK constraint but not an index on
`order_items.order_id`. **Postgres does not auto-create indexes on FK
columns** (unlike MySQL's InnoDB). Since "get items for order X" is the
primary access pattern, a missing index means a full table scan every time.

Added `index=True` to the model and manually added `create_index` /
`drop_index` to the migration.

**Lesson:** Always check autogenerated migrations for missing indexes on
FK columns, especially for one-to-many relationships where you query the
"many" side by FK.

---

## Python/SQLAlchemy Patterns Introduced

### Relationships with back_populates

```python
# Parent side (Order)
items: Mapped[list["OrderItem"]] = relationship(
    back_populates="order", cascade="all, delete-orphan"
)

# Child side (OrderItem)
order: Mapped["Order"] = relationship(back_populates="items")
```

`back_populates` creates bidirectional navigation. `cascade="all,
delete-orphan"` means deleting an Order also deletes its OrderItems (in
SQLAlchemy — the DB-level `ondelete="CASCADE"` handles it independently).

**Async gotcha:** With async SQLAlchemy, you must use `selectinload()` when
querying orders that need their items. Lazy loading (the default) doesn't
work in async mode — it tries to emit a synchronous SQL query inside an
async context and raises an error.

### Enum with values_callable

```python
status: Mapped[OrderStatus] = mapped_column(
    Enum(OrderStatus, values_callable=lambda e: [x.value for x in e]),
    default=OrderStatus.PENDING,
)
```

`values_callable` tells SQLAlchemy to store the enum *values* (`"pending"`,
`"paid"`) in Postgres, not the Python *names* (`"PENDING"`, `"PAID"`). This
matches what the frontend expects and makes the DB human-readable.

### Running Alembic in Docker

`alembic` CLI didn't find the `app` module when run directly. Fix:
```bash
docker compose exec backend bash -c "cd /app && python -m alembic upgrade head"
```

`python -m alembic` ensures Python's module resolution works because `/app`
is on `sys.path` as the current directory.

---

## Files Created

```
backend/app/models/order.py       — Order, OrderItem, OrderStatus
backend/app/schemas/order.py      — Checkout + order response schemas
backend/alembic/versions/1588ae692435_add_orders_and_order_items_tables.py
```

## Files Modified

```
backend/app/models/__init__.py    — Export new models for Alembic discovery
docs/todo.md                      — Mark 5A complete
```

---

## What's Next: Subphase 5B

Checkout endpoint (TDD):
- `POST /checkout/create-session` — looks up products, creates Stripe session
- Tests first: happy path, empty items, unavailable/nonexistent product
- Mock `stripe.checkout.Session.create` — never hit real Stripe in tests
- Inline `price_data` (no pre-created Stripe Prices)
