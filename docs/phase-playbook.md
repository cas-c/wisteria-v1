# Phase Playbook — Wisteria

Implementation details for upcoming phases. For architecture rules and
project-wide conventions, see [`agent-instructions.md`](agent-instructions.md).

Completed phases (0–4C) are archived in their respective takeaway docs.

---

## Phase 5: Checkout + Stripe
- **Security:** Add request body size limit (see ADR 012).
- **Critical:** Stripe webhook must read raw request body for signature
  verification. Use `Request.body()` before any JSON parsing.
- Create Order + OrderItems in the webhook handler, NOT the checkout
  endpoint. Checkout only creates a Stripe session.
- After order creation, mark purchased products as `is_available = False`.
- Send confirmation email via Resend in the webhook handler.
- Test locally: `stripe listen --forward-to localhost:8000/api/v1/webhooks/stripe`
- **TDD for all checkout/webhook backend code.**

## Phase 6: Admin Panel
- **Security:** Add token revocation / denylist (see ADR 012).
- JWT stored in memory (Zustand store, NOT localStorage — avoids XSS).
- Admin layout: sidebar with nav links, main content area.
- Auth guard: no valid JWT → redirect to /admin/login.
- Product soft-delete: set `is_available = False`, don't DELETE.
- Order status flow: pending → paid → shipped → cancelled.

## Phase 7: Polish + Deploy
- **Security:** Add security headers middleware, verify `DEBUG=false` (see ADR 012).
- error.tsx at app root and key route segments.
- Loading skeletons matching actual content layout (not generic spinners).
- Vercel: set `NEXT_PUBLIC_API_URL` to Railway backend URL.
- Railway: set all env vars from `.env.example`, use managed Postgres.
- Production Stripe webhook: `https://<railway-url>/api/v1/webhooks/stripe`.

---

## Known Pitfalls

1. **Don't return SQLAlchemy models from routes.** Convert to Pydantic schemas.
2. **Don't forget `await` on async DB ops.** You'll get a coroutine instead of results.
3. **Stripe webhook: raw body before JSON parsing** for signature verification.
4. **Never use `float` for money.** Always integer cents.
5. **Review Alembic autogenerated migrations** before running.
6. **Don't `git add .`** — `.env` files contain secrets.
7. **Use `bcrypt` directly, NOT passlib** (abandoned, breaks with bcrypt 4.1+).
8. **Use `NullPool` for test engine** — asyncpg connections bind to event loops.
9. **TRUNCATE before AND after tests** — seed data can pollute the first test.
10. **`HTTPAuthorizationCredentials.credentials`**, not `.token`.
11. **Tests must use `test_database_url`**, not `database_url`.
